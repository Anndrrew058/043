<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÜíÈö™ËÄÖÊóÖÁ®ã - V43 Êé¢Èö™ÂõûÈ•ãÁâà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        /* [ÂçÄÂ°ä A] 8 Ëâ≤‰∏ªÈ°åÂÆöÁæ© */
        :root { --p: #14b8a6; --bg: #020617; --c: #1e293b; --t: #f1f5f9; }
        .theme-dark-teal { --p: #14b8a6; --bg: #020617; --c: #1e293b; --t: #f1f5f9; }
        .theme-dark-pink { --p: #f472b6; --bg: #0f172a; --c: #1a1b2e; --t: #fce7f3; }
        .theme-dark-gold { --p: #fbbf24; --bg: #1c1917; --c: #292524; --t: #fef3c7; }
        .theme-dark-blue { --p: #3b82f6; --bg: #020617; --c: #1e293b; --t: #eff6ff; }
        .theme-light-mint { --p: #059669; --bg: #f0fdf4; --c: #ffffff; --t: #064e3b; }
        .theme-light-lavender { --p: #8b5cf6; --bg: #f5f3ff; --c: #ffffff; --t: #2e1065; }
        .theme-light-sky { --p: #0ea5e9; --bg: #f0f9ff; --c: #ffffff; --t: #0c4a6e; }
        .theme-light-clay { --p: #d97706; --bg: #fffbeb; --c: #ffffff; --t: #451a03; }

        body { background-color: var(--bg); color: var(--t); transition: all 0.5s; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: var(--c); border: 1px solid rgba(255,255,255,0.05); }
        .bg-primary { background-color: var(--p); }
        .text-primary { color: var(--p); }
        .border-primary { border-color: var(--p); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        
        /* Tooltip */
        .tooltip-content { opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
        .group:hover .tooltip-content { opacity: 1; visibility: visible; transform: translate(0, 0); }
        
        /* Boss Styles */
        .boss-card { border-color: #ef4444; background: linear-gradient(145deg, rgba(30,41,59,1) 0%, rgba(69,10,10,0.4) 100%); }
        .boss-icon { filter: drop-shadow(0 0 5px #ef4444); }
        
        @keyframes action-pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); filter: brightness(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: action-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .shake { animation: shake 0.4s ease-in-out; }
        .damage-shake { animation: damage 0.2s ease-in-out; }
        @keyframes damage { 0% { transform: translate(0,0) rotate(0deg); } 25% { transform: translate(5px, 5px) rotate(5deg); } 50% { transform: translate(-5px, -5px) rotate(-5deg); } 75% { transform: translate(5px, -5px) rotate(5deg); } 100% { transform: translate(0,0) rotate(0deg); } }
        
        /* Toast Animation */
        @keyframes slide-up { 0% { transform: translate(-50%, 100%); opacity: 0; } 100% { transform: translate(-50%, 0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        select { -webkit-appearance: none; -moz-appearance: none; text-indent: 1px; text-overflow: ''; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ---------------------------------------------------------------------
        // ÂÖßÂª∫ÂúñÁ§∫ÁµÑ‰ª∂ (SVG Icons)
        // ---------------------------------------------------------------------
        const Icon = ({ name, size = 16, className = "" }) => {
            const commonProps = { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className };
            if (name === 'ChevronDown') return <svg {...commonProps}><path d="m6 9 6 6 6-6"/></svg>;
            if (name === 'ChevronUp') return <svg {...commonProps}><path d="m18 15-6-6-6 6"/></svg>;
            if (name === 'Plus') return <svg {...commonProps}><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
            if (name === 'Trash2') return <svg {...commonProps}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
            if (name === 'CheckSquare') return <svg {...commonProps}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>;
            if (name === 'Square') return <svg {...commonProps}><rect width="18" height="18" x="3" y="3" rx="2"/></svg>;
            if (name === 'Calendar') return <svg {...commonProps}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
            if (name === 'Clock') return <svg {...commonProps}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
            if (name === 'Edit3') return <svg {...commonProps}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>;
            if (name === 'Lock') return <svg {...commonProps}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
            if (name === 'Settings') return <svg {...commonProps}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
            if (name === 'X') return <svg {...commonProps}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
            if (name === 'History') return <svg {...commonProps}><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>;
            if (name === 'Archive') return <svg {...commonProps}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>;
            if (name === 'Save') return <svg {...commonProps}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
            if (name === 'Sword') return <svg {...commonProps}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></svg>;
            if (name === 'AlertCircle') return <svg {...commonProps}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
            if (name === 'Bell') return <svg {...commonProps}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
            if (name === 'Dice') return <svg {...commonProps}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></svg>;
            if (name === 'Map') return <svg {...commonProps}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" x2="8" y1="2" y2="18"/><line x1="16" x2="16" y1="6" y2="22"/></svg>;
            if (name === 'Book') return <svg {...commonProps}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
            if (name === 'Image') return <svg {...commonProps}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;
            return null;
        };

        const THEMES = [
            { id: 'theme-dark-teal', color: '#14b8a6' }, { id: 'theme-dark-pink', color: '#f472b6' },
            { id: 'theme-dark-gold', color: '#fbbf24' }, { id: 'theme-dark-blue', color: '#3b82f6' },
            { id: 'theme-light-mint', color: '#059669' }, { id: 'theme-light-lavender', color: '#8b5cf6' },
            { id: 'theme-light-sky', color: '#0ea5e9' }, { id: 'theme-light-clay', color: '#d97706' }
        ];

        const AVATARS = ["‚öîÔ∏è", "üèπ", "üßô", "üõ°Ô∏è", "üêâ", "üê∫", "ü¶Ö", "üíé"];

        // ---------------------------------------------------------------------
        // [New] Â•áÈÅáË≥áÊñôÂ∫´
        // ---------------------------------------------------------------------
        const ENCOUNTER_DB = [
            { title: "Âπ∏ÈÅãÁöÑÁôºÁèæ", desc: "‰Ω†Âú®ËàäÂ§ñÂ•óÂè£Ë¢ãË£°ÁôºÁèæ‰∫ÜÁö∫Â∑¥Â∑¥ÁöÑÁ¥ôÂπ£ÔºÅ", icon: "üí∞", reward: { gold: 100 }, text: "ÁúüÊòØÂÄãÂ•ΩÂÖÜÈ†≠ÔºÅ" },
            { title: "ÊµÅÊµ™ÂïÜ‰∫∫", desc: "‰∏Ä‰ΩçÁ•ûÁßòÁöÑÂïÜ‰∫∫Ë∑ØÈÅéÔºåÈÄÅ‰∫Ü‰Ω†‰∏ÄÁì∂Ë©¶ÂñùËó•Ê∞¥„ÄÇ", icon: "üßô‚Äç‚ôÇÔ∏è", reward: { potions: { red: 1 } }, text: "Ë¨ùË¨ù‰Ω†ÁöÑÊÖ∑ÊÖ®ÔºÅ" },
            { title: "Á™ÅÂ¶ÇÂÖ∂‰æÜÁöÑÊö¥Èõ®", desc: "‰∏ÄÂ†¥Â§ßÈõ®Êää‰Ω†Ê∑ãÊàê‰∫ÜËêΩÊπØÈõûÔºå‰ΩÜ‰πüËÆì‰Ω†Êõ¥Ê∏ÖÈÜí‰∫Ü„ÄÇ", icon: "üåßÔ∏è", reward: { energy: -10, exp: 50 }, text: "ÈÄô‰πüÊòØ‰∏ÄÁ®Æ‰øÆË°å..." },
            { title: "Ë≤ìÂí™ÁöÑÁ¶ÆÁâ©", desc: "‰Ω†ÁöÑÂÆàË≠∑Áç∏‰∏çÁü•ÂæûÂì™Âèº‰æÜ‰∫Ü‰∏ÄÂÄãÂ•áÊÄ™ÁöÑÊù±Ë•ø...Â•ΩÂÉèÊòØËÇ•ÊñôÔºü", icon: "üêæ", reward: { items: { fertilizer: 1 } }, text: "ÂëÉ...Ë¨ùË¨ù‰Ω†Ôºü" },
            { title: "ÈùàÊÑüÊπßÁèæ", desc: "ËÖ¶‰∏≠Á™ÅÁÑ∂ÈñÉÈÅé‰∏ÄÂÄãÁµïÂ¶ôÁöÑÈªûÂ≠êÔºÅ", icon: "üí°", reward: { exp: 100 }, text: "Âø´Ë®ò‰∏ã‰æÜÔºÅ" },
            { title: "ÁæéÂë≥ÁöÑ‰æøÁï∂", desc: "‰ªäÂ§©ÁöÑÂçàÈ§êÁâπÂà•Â•ΩÂêÉÔºåÂÖÖÊªø‰∫ÜÂäõÈáèÔºÅ", icon: "üç±", reward: { energy: 50 }, text: "Ê≠ê‰ºäÁ≥ªÔºÅ" },
            { title: "ËÆÄÊõ∏ÊúÉ", desc: "ÂèÉÂä†‰∫Ü‰∏ÄÂ†¥ÊúâË∂£ÁöÑË¨õÂ∫ßÔºåÂ≠∏Âà∞‰∫ÜÊñ∞Áü•Ë≠ò„ÄÇ", icon: "üìö", reward: { exp: 150 }, text: "Áü•Ë≠òÂ∞±ÊòØÂäõÈáè„ÄÇ" }
        ];

        const DAILY_REMINDERS = [
            { id: 'water', text: "üíß Ë©≤ÂñùÊ∞¥ÂõâÔºÅË£úÂÖÖÊ∞¥ÂàÜ‰øùÊåÅÊ¥ªÂäõ„ÄÇ", interval: 90 * 60 * 1000, reward: { energy: 10, exp: 10 } },
            { id: 'eye', text: "üëÄ ËÆìÁúºÁùõ‰ºëÊÅØ‰∏Ä‰∏ãÔºåÁúãÁúãÈÅ†Êñπ„ÄÇ", interval: 45 * 60 * 1000, reward: { energy: 5, exp: 5 } },
            { id: 'stretch', text: "üôÜ‚Äç‚ôÇÔ∏è Ëµ∑‰æÜÂãï‰∏ÄÂãïÔºå‰º∏Â±ïÁ≠ãÈ™®ÔºÅ", interval: 180 * 60 * 1000, reward: { energy: 15, exp: 15 } }
        ];

        const PET_SPECIES = {
            cat: { name: 'Ë≤ìÂí™', icon: 'üê±', desc: 'ÈùàÊ¥ªÂÑ™ÈõÖÁöÑÂ§•‰º¥', evolutions: { A: { name: 'ÁôΩËôéÁ•ûÁç∏', icon: 'üêØ', desc: 'ÊéåÁÆ°Ë•øÊñπÁöÑÊà∞Á•û' }, B: { name: '‰πùÂëΩË≤ìÂ¶ñ', icon: 'üêà‚Äç‚¨õ', desc: 'Á©øÊ¢≠Èô∞ÈôΩÁöÑÈùàË≤ì' } } },
            dog: { name: 'ÁãóÁãó', icon: 'üê∂', desc: 'Âø†Ë™†ÂãáÊï¢ÁöÑË°õÂ£´', evolutions: { A: { name: 'Â§©ÁãºÊòü', icon: 'üê∫', desc: 'ÊíïË£ÇÈªëÊöóÁöÑÈäÄÁâô' }, B: { name: 'Âú∞ÁçÑÁä¨', icon: 'üêï', desc: 'ÂÆàË≠∑ÂÜ•ÁïåÁöÑ‰∏âÈ†≠Áä¨' } } },
            wolf: { name: 'Â≠§Áãº', icon: 'üê∫', desc: 'ËçíÈáé‰∏≠ÁöÑÁçµÊâã', evolutions: { A: { name: 'Ëä¨ÈáåÁàæ', icon: 'üå™Ô∏è', desc: 'ÂêûÂô¨Êó•ÊúàÁöÑÂ∑®Áãº' }, B: { name: 'ÂÜ∞ÂéüÁãº', icon: '‚ùÑÔ∏è', desc: 'Ê•µÂú∞ÂØíÂÜ∞ÁöÑ‰∏ªÂÆ∞' } } },
            fox: { name: 'ÁãêÁã∏', icon: 'ü¶ä', desc: 'ËÅ∞ÊòéÁã°Èª†ÁöÑÊô∫ËÄÖ', evolutions: { A: { name: '‰πùÂ∞æÂ§©Áãê', icon: 'üî•', desc: 'È≠ÖÊÉëÁúæÁîüÁöÑÂ¶ñÁ•û' }, B: { name: 'Á®ªËç∑Á•û‰Ωø', icon: '‚õ©Ô∏è', desc: 'Ë±êÊî∂ËàáË≤°ÂØåÁöÑË±°Âæµ' } } },
            owl: { name: 'Ë≤ìÈ†≠È∑π', icon: 'ü¶â', desc: 'Â§úË¶ñÂçÉÈáåÁöÑËßÄÂØüËÄÖ', evolutions: { A: { name: 'ÊöóÂ§ú‰∏ªÂÆ∞', icon: 'üåë', desc: 'ÁÑ°ËÅ≤ÁöÑÊöóÊÆ∫ËÄÖ' }, B: { name: 'Êô∫ÊÖßÁ•ûÈ≥•', icon: 'üìú', desc: 'ÂÖ®Áü•ÂÖ®ËÉΩÁöÑÂ≠∏ËÄÖ' } } },
            dragon: { name: 'ÂπºÈæç', icon: 'ü¶é', desc: 'ÊΩõËóèÂäõÈáèÁöÑÂπºÈõõ', evolutions: { A: { name: 'Â∑¥ÂìàÂßÜÁâπ', icon: 'üêâ', desc: 'Ëê¨Èæç‰πãÁéãÁöÑÂ®ÅÂö¥' }, B: { name: 'Êèê‰∫ûÈ¶¨Áâπ', icon: 'üê≤', desc: 'Ê∑∑Ê≤å‰πãÊØçÁöÑÁãÇÊö¥' } } }
        };

        const SHOP_ITEMS = [
            { i: 'dry_food', t: 'item', c: 100, n: 'üç™ ÂØµÁâ©‰πæÁ≥ß', desc: 'ÊôÆÈÄöÁöÑÂØµÁâ©È£üÂìÅÔºåÁ®çÂæÆÊÅ¢Âæ©È£ΩÈ£üÂ∫¶„ÄÇ' },
            { i: 'food', t: 'item', c: 450, n: 'ü•© ÂÑ™Ë≥™ËÇâÂ°ä', desc: 'ÁáüÈ§äË±êÂØåÔºåÂ§ßÂπÖÊÅ¢Âæ©È£ΩÈ£üÂ∫¶„ÄÇ' },
            { i: 'canned_food', t: 'item', c: 800, n: 'üêü ÁâπÁ¥öÁΩêÈ†≠', desc: 'ÁæéÂë≥ÁÑ°ÊØîÔºåÊÅ¢Âæ©Â§ßÈáèÈ£ΩÈ£üËàáÂøÉÊÉÖ„ÄÇ' },
            { i: 'cat_nip', t: 'item', c: 300, n: 'üåø Ë≤ìËçâ/ËàíÁ∑©Ëçâ', desc: 'ËÆìÂØµÁâ©ÊîæÈ¨ÜÔºåÊÅ¢Âæ©ÂøÉÊÉÖ„ÄÇ' },
            { i: 'fertilizer', t: 'item', c: 250, n: 'üí© ÁâπË≥™ËÇ•Êñô', desc: 'Âä†ÈÄüÊ§çÁâ©ÁîüÈï∑„ÄÇ' },
            { i: 'toy', t: 'item', c: 150, n: 'üß∂ ÈÄóË≤ìÊ£í', desc: 'Èô™ÂØµÁâ©Áé©ËÄçÔºåÂ¢ûÂä†Ë¶™ÂØÜÂ∫¶„ÄÇ' },
            { i: 'bandage', t: 'item', c: 200, n: 'ü©π ÈÜ´ÁôÇÁπÉÂ∏∂', desc: 'Ê≤ªÁôÇËºïÂÇ∑ÔºåÊÅ¢Âæ©ÂÅ•Â∫∑„ÄÇ' },
            { i: 'med_kit', t: 'item', c: 1500, n: 'üöë ÊÄ•ÊïëÁÆ±', desc: 'Ê≤ªÁôÇÈáçÂÇ∑ÔºåÊåΩÊïëÂç±Ê©ü„ÄÇ' },
            { i: 'red', t: 'potion', c: 300, n: 'üß™ ÁîüÂëΩËó•Âäë', desc: 'ÊÅ¢Âæ©Áé©ÂÆ∂ËÉΩÈáè„ÄÇ' },
            { i: 'gold', t: 'potion', c: 1200, n: 'üß™ ÈªûÈáëËó•Âäë', desc: 'Ê∂àËÄóËÉΩÈáèÊèõÂèñÈáëÂπ£„ÄÇ' },
            { i: 'purple', t: 'potion', c: 2000, n: 'üß™ Ë≥¢ËÄÖËó•Âäë', desc: 'Áõ¥Êé•Áç≤ÂæóÁ∂ìÈ©óÂÄº„ÄÇ' },
        ];

        // Êé¢Èö™Âú∞ÈªûËàáÊéâËêΩÁâ©
        const ADVENTURE_LOCATIONS = [
            { id: 'forest', name: 'Ëø∑ÈúßÊ£ÆÊûó', time: 2, cost: 20, loot: ['forest_card', 'ancient_coin', 'leaf_charm'] },
            { id: 'beach', name: 'ÈôΩÂÖâÊ≤ôÁÅò', time: 4, cost: 40, loot: ['beach_card', 'shell_necklace', 'pearl'] },
            { id: 'ruins', name: 'Âè§ËÄÅÈÅ∫Ë∑°', time: 8, cost: 80, loot: ['ruins_card', 'dragon_scale', 'stone_tablet'] }
        ];

        const COLLECTION_DB = {
            'forest_card': { name: 'Ê£ÆÊûóÊòé‰ø°Áâá', type: 'postcard', icon: 'üå≤', desc: 'ËåÇÂØÜÁöÑÊ£ÆÊûóÊ∑±ËôïÔºåÂΩ∑ÂΩøÊúâÁ≤æÈùàÂ±Ö‰Ωè„ÄÇ' },
            'beach_card': { name: 'Êµ∑ÁÅòÊòé‰ø°Áâá', type: 'postcard', icon: 'üèñÔ∏è', desc: 'ÈôΩÂÖâÊôÆÁÖßÁöÑÊ≤ôÁÅòÔºå‰ª§‰∫∫ÂøÉÊõ†Á•ûÊÄ°„ÄÇ' },
            'ruins_card': { name: 'ÈÅ∫Ë∑°Êòé‰ø°Áâá', type: 'postcard', icon: 'üèõÔ∏è', desc: 'Âè§ÊñáÊòéÁöÑÊÆòÂû£Êñ∑Â£ÅÔºåË®¥Ë™™ËëóÊ≠∑Âè≤„ÄÇ' },
            'ancient_coin': { name: 'Âè§ËÄÅÁ°¨Âπ£', type: 'artifact', icon: 'ü™ô', desc: 'ÂàªÊúâÊú™Áü•ÊñáÂ≠óÁöÑÂè§Âπ£„ÄÇ' },
            'leaf_charm': { name: 'ËëâÂ≠êË≠∑Á¨¶', type: 'artifact', icon: 'üçÉ', desc: 'Á∑®ÁπîÁ≤æÁæéÁöÑËëâÂ≠êË≠∑Ë∫´Á¨¶„ÄÇ' },
            'shell_necklace': { name: 'Ë≤ùÊÆºÈ†ÖÈçä', type: 'artifact', icon: 'üêö', desc: '‰∏≤ËëóÁæéÈ∫óË≤ùÊÆºÁöÑÈ†ÖÈçä„ÄÇ' },
            'pearl': { name: 'ÂÖâÊæ§ÁèçÁè†', type: 'artifact', icon: '‚ö™', desc: 'ÂúìÊΩ§È£ΩÊªøÁöÑÁèçÁè†„ÄÇ' },
            'dragon_scale': { name: 'Èæç‰πãÈ±óÁâá', type: 'artifact', icon: 'üê≤', desc: 'Êï£ÁôºËëóÂæÆÁÜ±ÁöÑÂ†ÖÁ°¨È±óÁâá„ÄÇ' },
            'stone_tablet': { name: 'Áü≥ÊùøÁ¢éÁâá', type: 'artifact', icon: 'ü™®', desc: 'Ë®òËºâËëóÂè§ËÄÅÈ†êË®ÄÁöÑÁü≥Êùø„ÄÇ' }
        };

        const LocalDatabase = {
            categories: [
                { type: 'ÂäõÈáè', icon: '‚öîÔ∏è', keywords: ['Ë∑ë', 'ÂÅ•Ë∫´', 'ÊâìÁêÉ', 'ÈÅãÂãï', 'Áà¨Â±±', 'Ë®ìÁ∑¥', 'ÈáçË®ì', 'Ëµ∞'] },
                { type: 'Êô∫ÊÖß', icon: 'üîÆ', keywords: ['Â≠∏', 'ËÆÄ', 'ÂØ´', 'Ë™≤', 'ËÄÉ', 'Á†îÁ©∂', 'Á∑®Á®ã', 'Â∑•‰Ωú', 'Â†±Âëä', 'ÊúÉË≠∞', 'Â†±Âà∞'] },
                { type: 'ÈùàÈ≠Ç', icon: '‚ú®', keywords: ['ÂÜ•ÊÉ≥', 'Áù°', '‰ºëÊÅØ', 'ÊîæÈ¨Ü', 'Èü≥Ê®Ç', 'ÈùúÂùê', 'Á¶±Âëä', 'ÁëúÁèà'] },
                { type: 'Á§æ‰∫§', icon: 'ü§ù', keywords: ['ËÅöÊúÉ', 'ËÅä', 'ÈõªË©±', 'Ë¶ãÈù¢', 'Á¥ÑÊúÉ', 'Èô™‰º¥', 'ÂÆ∂', 'Âèã'] },
                { type: 'ÁîüÊ¥ª', icon: 'üè†', keywords: ['Ê¥ó', 'ÊéÉ', 'Ë≤∑', 'ÁÖÆ', 'ÂêÉ', 'Êï¥ÁêÜ', 'ÂûÉÂúæ', 'Ëä±', 'Áπ≥Ë≤ª', 'Ë≠â‰ª∂'] }
            ],
            autoClassify: (text) => {
                for (let cat of LocalDatabase.categories) {
                    if (cat.keywords.some(k => text.includes(k))) return { type: cat.type, icon: cat.icon };
                }
                return { type: 'Êó•Â∏∏', icon: 'üìú' };
            }
        };

        const SoundEngine = {
            play: (type) => {
                const sounds = {
                    click: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',
                    success: 'https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3',
                    fail: 'https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3',
                    potion: 'https://assets.mixkit.co/active_storage/sfx/611/611-preview.mp3',
                    water: 'https://assets.mixkit.co/active_storage/sfx/1118/1118-preview.mp3',
                    eat: 'https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3',
                    subtask: 'https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3',
                    meow: 'https://assets.mixkit.co/active_storage/sfx/3004/3004-preview.mp3',
                    harvest: 'https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3',
                    attack: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',
                    victory: 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3',
                    notification: 'https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3'
                };
                try {
                    const audio = new Audio(sounds[type]);
                    audio.volume = 0.4;
                    const playPromise = audio.play();
                    if (playPromise !== undefined) { playPromise.catch(error => {}); }
                } catch(e) {}
            }
        };

        const GrowthSystem = {
            getTreeStage: (exp) => {
                if (exp < 10) return { icon: 'üå±', name: 'ÂπºËãóÊúü', next: 'ÊàêÈï∑Êúü', nextExp: 10 };
                if (exp < 50) return { icon: 'üåø', name: 'ÊàêÈï∑Êúü', next: 'Á•ûÊú®Êúü', nextExp: 50 };
                return { icon: 'üå≥', name: 'Á•ûÊú®Êúü', next: 'Â∑≤ÈÅîÂ∑îÂ≥∞', nextExp: null };
            },
            getPetStage: (exp, type = 'cat', divinePath = null) => {
                const speciesData = PET_SPECIES[type] || PET_SPECIES['cat'];
                if (exp < 15) return { icon: speciesData.icon, name: `ÂπºÂπ¥${speciesData.name}`, next: `ÊàêÂπ¥${speciesData.name}`, nextExp: 15 };
                if (exp < 100) return { icon: speciesData.icon, name: `ÊàêÂπ¥${speciesData.name}`, next: `Á•ûÁç∏ÈÄ≤Âåñ`, nextExp: 100 };
                if (divinePath && speciesData.evolutions[divinePath]) {
                    const evo = speciesData.evolutions[divinePath];
                    return { icon: evo.icon, name: evo.name, next: 'Â∑≤ÈÅîÂ∑îÂ≥∞', nextExp: null };
                }
                return { icon: speciesData.icon, name: `Á•ûÁç∏${speciesData.name}`, next: 'Â∑≤ÈÅîÂ∑îÂ≥∞', nextExp: null };
            }
        };

        // ---------------------------------------------------------------------
        // Tooltip ÁµÑ‰ª∂
        // ---------------------------------------------------------------------
        const Tooltip = ({ content, children, position = 'top' }) => {
            const posClass = position === 'bottom' ? 'top-full mt-2' : 'bottom-full mb-2';
            const arrowClass = position === 'bottom' ? 'bottom-full border-b-slate-800' : 'top-full border-t-slate-800';
            const arrowBorder = position === 'bottom' ? 'border-b-8 border-x-8 border-x-transparent' : 'border-t-8 border-x-8 border-x-transparent';

            return (
                <div className="group relative flex items-center justify-center">
                    {children}
                    <div className={`tooltip-content absolute ${posClass} w-max max-w-xs bg-slate-800 border border-primary/30 text-xs rounded-lg p-3 shadow-xl z-50 pointer-events-none text-left`}>
                        {content}
                        <div className={`absolute left-1/2 -translate-x-1/2 ${arrowClass} ${arrowBorder}`}></div>
                    </div>
                </div>
            );
        };

        const Modal = ({ title, children, onClose, width = 'max-w-sm' }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                <div className={`bg-slate-800 border-2 border-primary rounded-2xl p-6 w-full ${width} shadow-2xl relative animate-pop max-h-[90vh] overflow-y-auto`}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white/50 hover:text-white z-10"><Icon name="X" /></button>
                    <h3 className="text-xl font-bold text-primary mb-4 text-center">{title}</h3>
                    {children}
                </div>
            </div>
        );

        // ---------------------------------------------------------------------
        // [Component] ÊâπÈáèÈÅ∏ÊìáÁµÑ‰ª∂ (Select)
        // ---------------------------------------------------------------------
        const BulkInput = ({ value, onChange }) => (
            <div className="flex items-center gap-2 bg-black/20 px-2 py-1 rounded-lg text-xs border border-white/5">
                <span className="opacity-50">ÊâπÈáè</span>
                <select 
                    value={value} 
                    onChange={(e) => onChange(parseInt(e.target.value))} 
                    className="bg-transparent text-center outline-none font-bold cursor-pointer appearance-none text-right pr-1"
                    style={{textAlignLast: 'center'}}
                >
                    <option value={1} className="bg-slate-800 text-white">x1</option>
                    {[10, 20, 30, 40, 50, 60, 70, 80, 90, 100].map(num => (
                        <option key={num} value={num} className="bg-slate-800 text-white">x{num}</option>
                    ))}
                </select>
                <Icon name="ChevronDown" size={10} className="opacity-50 pointer-events-none" />
            </div>
        );

        function App() {
            const [player, setPlayer] = useState(() => {
                const saved = JSON.parse(localStorage.getItem('v43_p'));
                const defaultData = { 
                    name: 'ÂÜíÈö™ËÄÖ', lv: 1, xp: 0, gold: 500, energy: 100, avatar: "‚öîÔ∏è",
                    potions: { red: 1, gold: 0, purple: 0 }, 
                    items: { fertilizer: 0, food: 0, dry_food: 0, canned_food: 0, cat_nip: 0, toy: 0, fruit: 0, bandage: 0, med_kit: 0 },
                    collection: { postcards: [], artifacts: [] },
                    theme: 'theme-dark-teal',
                    base: {
                        treeName: 'Â∏åÊúõ‰πãÊ®π', treeExp: 0, treeProgress: 0,
                        petName: 'Â∞èÂ§•‰º¥', petExp: 0, petHunger: 80, petMood: 80, petStamina: 100, petType: null, divinePath: null,
                        petStatus: 'idle', // 'idle', 'exploring', 'injured', 'critical'
                        adventureEndTime: null, adventureLocation: null,
                        lastUpdate: Date.now()
                    }
                };
                return saved ? { ...defaultData, ...saved, base: { ...defaultData.base, ...saved.base } } : defaultData;
            });
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('v43_t')) || []);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('v43_h')) || []);
            
            const [activeEncounter, setActiveEncounter] = useState(null);
            const [pendingReminders, setPendingReminders] = useState([]);
            const [toast, setToast] = useState(null);
            const [showReminderDropdown, setShowReminderDropdown] = useState(false);
            const reminderRef = useRef(null); // Ref for reminder dropdown

            const [bulkAmount, setBulkAmount] = useState(1);
            const [input, setInput] = useState({ text: '', mode: 'duration', hours: 24, date: '' });
            const [showAvatars, setShowAvatars] = useState(false);
            const [activeAnim, setActiveAnim] = useState(null);
            const [isShaking, setIsShaking] = useState(false);
            const [curTime, setCurTime] = useState(new Date());
            const [expandedTaskId, setExpandedTaskId] = useState(null);
            const [viewMode, setViewMode] = useState('active');

            const [modalConfig, setModalConfig] = useState(null);
            const [tempInput, setTempInput] = useState('');

            const maxEnergy = 100 + (player.lv * 15);
            const maxExp = player.lv * 1000;

            const showToast = (message) => {
                setToast(message);
                setTimeout(() => setToast(null), 3000);
            };

            const formatTime = (ms) => {
                const totalSeconds = Math.max(0, Math.floor(ms / 1000));
                const m = Math.floor(totalSeconds / 60);
                const s = totalSeconds % 60;
                return `${m}ÂàÜ${s}Áßí`;
            };

            // Click outside handler for reminder dropdown
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (reminderRef.current && !reminderRef.current.contains(event.target)) {
                        setShowReminderDropdown(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, []);

            // Á≥ªÁµ±Ë®àÊôÇÂô® (Â•áÈÅá„ÄÅÊèêÈÜí„ÄÅÂØµÁâ©ÁãÄÊÖã)
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = Date.now();
                    
                    // Èö®Ê©üÂ•áÈÅá
                    if (!activeEncounter && Math.random() < 0.05) {
                        const randomEncounter = ENCOUNTER_DB[Math.floor(Math.random() * ENCOUNTER_DB.length)];
                        setActiveEncounter(randomEncounter);
                        SoundEngine.play('notification');
                    }

                    // ÊØèÊó•ÊèêÈÜí
                    const newReminders = [];
                    DAILY_REMINDERS.forEach(reminder => {
                        const lastTrigger = parseInt(localStorage.getItem(`reminder_${reminder.id}`) || '0');
                        if (now - lastTrigger > reminder.interval) {
                            newReminders.push(reminder);
                            localStorage.setItem(`reminder_${reminder.id}`, now.toString());
                        }
                    });

                    if (newReminders.length > 0) {
                        setPendingReminders(prev => [...prev, ...newReminders]);
                        SoundEngine.play('notification');
                    }

                    // ÂØµÁâ©ÂÜíÈö™ÂõûÊ≠∏Ê™¢Êü•
                    if (player.base.petStatus === 'exploring' && player.base.adventureEndTime && now >= player.base.adventureEndTime) {
                        completeAdventure();
                    }

                    // ÂØµÁâ©Ëá™ÁÑ∂ÁãÄÊÖãÊ∂àËÄó
                    setPlayer(p => {
                        if (p.lv < 9) return p;
                        
                        // Êé¢Èö™‰∏≠‰∏çÊâ£È£ΩÈ£üÂøÉÊÉÖÔºå‰ΩÜÊâ£ÊôÇÈñì
                        if (p.base.petStatus === 'exploring') return p;

                        // ÁôÇÈ§ä‰∏≠ÊÅ¢Âæ©
                        if (p.base.petStatus === 'critical') {
                            // ÈÄôË£°ÂèØ‰ª•ÂÅöËá™ÂãïÊÅ¢Âæ©ÈÇèËºØÔºåÊö´ÊôÇÊâãÂãïÊ≤ªÁôÇ
                            return p;
                        }

                        // ÈñíÁΩÆÁãÄÊÖã
                        const newHunger = Math.max(0, p.base.petHunger - 1);
                        const newMood = Math.max(0, p.base.petMood - 1);
                        const newStamina = Math.min(100, p.base.petStamina + 1); // ÊÖ¢ÊÖ¢ÂõûÈ´î
                        
                        let newProgress = p.base.treeProgress;
                        if (newProgress < 100) newProgress += 0.2; 

                        return { ...p, base: { ...p.base, petHunger: newHunger, petMood: newMood, petStamina: newStamina, treeProgress: newProgress } };
                    });

                }, 60000); // ÊØèÂàÜÈêòÊ™¢Êü•
                return () => clearInterval(timer);
            }, [activeEncounter, player.base.petStatus, player.base.adventureEndTime]);

            useEffect(() => {
                localStorage.setItem('v43_p', JSON.stringify(player));
                localStorage.setItem('v43_t', JSON.stringify(tasks));
                localStorage.setItem('v43_h', JSON.stringify(history));
                document.body.className = player.theme;
                const timer = setInterval(() => setCurTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, [player, tasks, history]);

            useEffect(() => {
                if (player.lv >= 9 && !player.base.petType && !modalConfig) {
                    setModalConfig({ type: 'select_species' });
                } else if (player.base.petExp >= 100 && !player.base.divinePath && !modalConfig) {
                    setModalConfig({ type: 'evolve_species' });
                }
            }, [player.lv, player.base.petExp, player.base.petType, player.base.divinePath]);

            const addExp = (amt, goldAmt = 0) => {
                setPlayer(p => {
                    let nXp = p.xp + amt;
                    let nLv = p.lv;
                    let nGold = p.gold + goldAmt;
                    let nEnergy = p.energy;
                    let nPot = { ...p.potions };
                    while (nXp >= nLv * 1000) {
                        nXp -= nLv * 1000; nLv++; nEnergy += 50; nGold += nLv * 150; nPot.red += 1;
                        confetti(); SoundEngine.play('success'); showToast(`ÂçáÁ¥öÂï¶ÔºÅÁ≠âÁ¥ö ${nLv}`);
                    }
                    return { ...p, xp: nXp, lv: nLv, gold: nGold, energy: nEnergy, potions: nPot };
                });
            };

            const handleMystery = (cmd) => {
                const match = cmd.match(/(exp|gold|hp|all)\((\d+)\)/);
                
                // ËôïÁêÜÁâπÊÆäÂ≠ó‰∏≤Êåá‰ª§
                const isSpecialCommand = ['reset_pet', 'max_pet', 'trigger_event', 'trigger_remind'].includes(cmd);
                
                if (!match && !isSpecialCommand) return false;

                if (match) {
                    const [_, type, val] = match;
                    const num = parseInt(val);
                    if (type === 'exp' || type === 'all') addExp(num);
                    if (type === 'gold' || type === 'all') setPlayer(p => ({ ...p, gold: p.gold + num }));
                    if (type === 'hp' || type === 'all') setPlayer(p => ({ ...p, energy: Math.min(maxEnergy, p.energy + num) }));
                }

                if (cmd === 'reset_pet') setPlayer(p => ({ ...p, base: { ...p.base, petType: null, petExp: 0, divinePath: null } })); 
                if (cmd === 'max_pet') setPlayer(p => ({ ...p, base: { ...p.base, petExp: 100 } })); 
                if (cmd === 'trigger_event') setActiveEncounter(ENCOUNTER_DB[0]);
                if (cmd === 'trigger_remind') setPendingReminders([...pendingReminders, DAILY_REMINDERS[0]]);
                
                SoundEngine.play('success');
                showToast("Êåá‰ª§Â∑≤Âü∑Ë°å");
                return true;
            };

            const shopBuy = (item, type, cost) => {
                const quantity = Number(bulkAmount) || 1;
                const totalCost = cost * quantity;
                if (player.gold >= totalCost) {
                    SoundEngine.play('click');
                    setPlayer(p => {
                        let newP = { ...p, gold: p.gold - totalCost };
                        if (type === 'potion') newP.potions[item] = (newP.potions[item] || 0) + quantity;
                        else newP.items[item] = (newP.items[item] || 0) + quantity;
                        return newP;
                    });
                    showToast(`üõí Ë≥ºË≤∑ÊàêÂäüÔºö${quantity} ÂÄãÈÅìÂÖ∑`);
                } else {
                    setIsShaking(true); setTimeout(()=>setIsShaking(false), 400); showToast(`‚ùå ÈáëÂπ£‰∏çË∂≥ÔºÅ`);
                }
            };

            const usePotion = (type) => {
                 if (player.potions[type] <= 0) return;
                 if (type === 'gold' && player.energy < 30) { setIsShaking(true); setTimeout(()=>setIsShaking(false), 400); return; }
                 SoundEngine.play('potion');
                 setPlayer(p => {
                    let nPot = { ...p.potions, [type]: p.potions[type] - 1 };
                    if (type === 'red') return { ...p, potions: nPot, energy: Math.min(maxEnergy, p.energy + 60) };
                    if (type === 'gold') return { ...p, potions: nPot, gold: p.gold + 1200, energy: p.energy - 30 };
                    if (type === 'purple') { addExp(2500); return { ...p, potions: nPot }; }
                    return p;
                 });
                 showToast(`üß™ ‰ΩøÁî®‰∫ÜËó•Âäë`);
            };

            const handleBaseAction = (action) => {
                let currentStock = 0;
                // mapping action to item key
                const map = { 'fertilize': 'fertilizer', 'feed': 'food', 'dry_food': 'dry_food', 'canned': 'canned_food', 'cat_nip': 'cat_nip', 'toy': 'toy' };
                currentStock = player.items[map[action]];
                
                const requestedAmount = Number(bulkAmount) || 1;
                const amount = Math.min(requestedAmount, currentStock);

                if (amount > 0) {
                     let updates = {};
                     if (action === 'fertilize') {
                         SoundEngine.play('water'); setActiveAnim('f');
                         updates = { treeProgress: 25 * amount, treeExp: 2 * amount };
                         showToast(`üíß ÊñΩËÇ•ÊàêÂäü x${amount}`);
                     } else {
                         // Pet actions
                         SoundEngine.play(action === 'toy' ? 'meow' : 'eat'); setActiveAnim('p');
                         if (action === 'feed') { updates = { petHunger: 40 * amount, petExp: 2 * amount }; showToast(`ü•© È§µÈ£üÊàêÂäü x${amount}`); }
                         if (action === 'dry_food') { updates = { petHunger: 20 * amount, petExp: 1 * amount }; showToast(`üç™ È§µÈ£üÊàêÂäü x${amount}`); }
                         if (action === 'canned') { updates = { petHunger: 80 * amount, petMood: 20 * amount, petExp: 5 * amount }; showToast(`üêü È§µÈ£üÊàêÂäü x${amount}`); }
                         if (action === 'cat_nip') { updates = { petMood: 50 * amount, petExp: 2 * amount }; showToast(`üåø ‰ΩøÁî®ÊàêÂäü x${amount}`); }
                         if (action === 'toy') { setActiveAnim('toy'); updates = { petMood: 30 * amount, petExp: 3 * amount }; showToast(`üß∂ Áé©ËÄçÊàêÂäü x${amount}`); }
                     }

                     setPlayer(p => {
                         const newItems = { ...p.items, [map[action]]: p.items[map[action]] - amount };
                         let newBase = { ...p.base };
                         if (updates.treeProgress) newBase.treeProgress = Math.min(100, newBase.treeProgress + updates.treeProgress);
                         if (updates.treeExp) newBase.treeExp += updates.treeExp;
                         if (updates.petHunger) newBase.petHunger = Math.min(100, newBase.petHunger + updates.petHunger);
                         if (updates.petMood) newBase.petMood = Math.min(100, newBase.petMood + updates.petMood);
                         if (updates.petExp) newBase.petExp += updates.petExp;
                         return { ...p, items: newItems, base: newBase };
                     });
                     setTimeout(() => setActiveAnim(null), 600);
                } else {
                    setIsShaking(true); setTimeout(()=>setIsShaking(false), 400); showToast(`‚ùå ÈÅìÂÖ∑‰∏çË∂≥ÔºÅ`);
                }
            };

            const harvestFruit = () => {
                if (player.base.treeProgress >= 100) {
                    SoundEngine.play('harvest');
                    setPlayer(p => ({ ...p, items: { ...p.items, fruit: p.items.fruit + 1 }, base: { ...p.base, treeProgress: 0 } }));
                    addExp(50);
                    showToast(`üçé Êé°Êî∂‰∫ÜÂ•áËπüÊûúÂØ¶ÔºÅ`);
                }
            };

            const consumeFruit = () => {
                if (player.items.fruit > 0) {
                    SoundEngine.play('eat');
                    setPlayer(p => ({ ...p, energy: Math.min(maxEnergy, p.energy + 80), items: { ...p.items, fruit: p.items.fruit - 1 } }));
                    showToast(`üçé ÂêÉ‰∫ÜÊûúÂØ¶ÔºåËÉΩÈáèÊªøÊªøÔºÅ`);
                }
            };

            const startAdventure = (locationId) => {
                const location = ADVENTURE_LOCATIONS.find(l => l.id === locationId);
                if (player.base.petStamina < location.cost) {
                    showToast("‚ùå È´îÂäõ‰∏çË∂≥ÔºÅ"); return;
                }
                if (player.base.petStatus !== 'idle') {
                    showToast("‚ùå ÂØµÁâ©ÁãÄÊÖã‰∏çÈÅ©ÂêàÊé¢Èö™"); return;
                }

                setPlayer(p => ({
                    ...p,
                    base: {
                        ...p.base,
                        petStatus: 'exploring',
                        petStamina: p.base.petStamina - location.cost,
                        adventureLocation: locationId,
                        adventureEndTime: Date.now() + (location.time * 60 * 1000) // mins to ms
                    }
                }));
                setModalConfig(null);
                showToast(`üéí ${player.base.petName} Âá∫ÁôºÂéª ${location.name} ‰∫ÜÔºÅ`);
            };

            const completeAdventure = () => {
                const locId = player.base.adventureLocation;
                const location = ADVENTURE_LOCATIONS.find(l => l.id === locId);
                
                // Calculate Outcome
                const successChance = (player.base.petMood + player.base.petHunger) / 200; // 0.0 - 1.0
                const roll = Math.random();
                
                let result = { type: 'success', msg: '', reward: {} };
                
                if (roll > successChance + 0.1) { // Injured
                     // 20% chance of critical injury if very unlucky
                     if (Math.random() < 0.2) {
                         result.type = 'critical';
                         result.msg = `${player.base.petName} Âèó‰∫ÜÈáçÂÇ∑Âõû‰æÜÔºåÈúÄË¶ÅÁ∑äÊÄ•Ê≤ªÁôÇÔºÅ`;
                     } else {
                         result.type = 'injured';
                         result.msg = `${player.base.petName} Âú®Êé¢Èö™‰∏≠Âèó‰∫ÜÈªûËºïÂÇ∑„ÄÇ`;
                     }
                } else {
                    result.type = 'success';
                    result.msg = `${player.base.petName} Âπ≥ÂÆâÊ≠∏‰æÜÔºÅ`;
                    // Loot logic
                    const expGain = location.time * 50;
                    const goldGain = location.time * 30;
                    addExp(expGain, goldGain); // Add directly

                    // Item loot
                    if (Math.random() < 0.3) {
                        const lootItem = location.loot[Math.floor(Math.random() * location.loot.length)];
                        // Add to collection if not exists, or just inventory logic?
                        // Let's put in collection
                        setPlayer(p => {
                            const newCol = { ...p.collection };
                            if (COLLECTION_DB[lootItem].type === 'postcard') {
                                if (!newCol.postcards.includes(lootItem)) newCol.postcards.push(lootItem);
                            } else {
                                if (!newCol.artifacts.includes(lootItem)) newCol.artifacts.push(lootItem);
                            }
                            return { ...p, collection: newCol };
                        });
                        // Pass loot item ID to result for display
                        result.loot = lootItem;
                        result.msg += ` Áç≤Âæó‰∫Ü ${COLLECTION_DB[lootItem].name}ÔºÅ`;
                    }
                }

                setPlayer(p => ({
                    ...p,
                    base: {
                        ...p.base,
                        petStatus: result.type === 'success' ? 'idle' : result.type,
                        adventureLocation: null,
                        adventureEndTime: null
                    }
                }));

                setModalConfig({ type: 'adventure_result', result });
            };

            const treatPet = (method) => {
                if (method === 'bandage') {
                    if (player.items.bandage > 0) {
                        setPlayer(p => ({ ...p, items: { ...p.items, bandage: p.items.bandage - 1 }, base: { ...p.base, petStatus: 'idle', petMood: p.base.petMood + 20 } }));
                        showToast("ü©π ÂåÖÁ¥ÆÂÆåÊàêÔºåÂØµÁâ©ÊÅ¢Âæ©‰∫ÜÔºÅ");
                    } else showToast("‚ùå Ê≤íÊúâÁπÉÂ∏∂ÔºÅ");
                } else if (method === 'med_kit') {
                    if (player.items.med_kit > 0) {
                        setPlayer(p => ({ ...p, items: { ...p.items, med_kit: p.items.med_kit - 1 }, base: { ...p.base, petStatus: 'idle', petStamina: 50 } }));
                        showToast("üöë ÊÄ•ÊïëÊàêÂäüÔºåÂØµÁâ©ËÑ´Èõ¢Âç±Èö™ÔºÅ");
                    } else showToast("‚ùå Ê≤íÊúâÊÄ•ÊïëÁÆ±ÔºÅ");
                }
            };

            const handleAddTask = () => {
                if (!input.text) return;
                if (handleMystery(input.text)) { setInput({ ...input, text: '' }); return; }
                const { type, icon } = LocalDatabase.autoClassify(input.text);
                let deadline = input.mode === 'date' && input.date ? new Date(input.date).getTime() : new Date().getTime() + (input.hours * 3600000);
                const finalDurationHours = Math.max(1, Math.floor((deadline - new Date().getTime()) / 3600000));
                
                const isBoss = finalDurationHours > 72;
                
                const newTaskId = Date.now();
                setTasks([{ 
                    id: newTaskId, 
                    content: input.text, 
                    type, 
                    icon: isBoss ? 'üëπ' : icon, 
                    deadline, 
                    gold: Math.max(10, finalDurationHours * 50), 
                    exp: Math.max(20, finalDurationHours * 100), 
                    subtasks: [],
                    isBoss: isBoss
                }, ...tasks]);
                SoundEngine.play('click');
                setInput({ ...input, text: '' });
                setExpandedTaskId(newTaskId);
                showToast(isBoss ? "üëπ BOSS Á¥ö‰ªªÂãôÂ∑≤ÁôºÂ∏ÉÔºÅ" : "üìú Êñ∞ÂßîË®óÂ∑≤Âª∫Á´ã");
            };

            const addSubtask = (taskId, text) => {
                if (!text.trim()) return;
                setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), { id: Date.now(), text, completed: false }] } : t));
                SoundEngine.play('click');
            };

            const toggleSubtask = (taskId, subtaskId) => {
                const task = tasks.find(t => t.id === taskId);
                const isBossAction = task && task.isBoss;

                if (isBossAction) {
                    setActiveAnim(taskId); 
                    SoundEngine.play('attack');
                    setTimeout(() => setActiveAnim(null), 200);
                } else {
                    SoundEngine.play('subtask');
                }

                setTasks(tasks.map(t => {
                    if (t.id === taskId) return { ...t, subtasks: (t.subtasks || []).map(st => st.id === subtaskId ? { ...st, completed: !st.completed } : st) };
                    return t;
                }));
                
                if (isBossAction) addExp(50, 20);
                else addExp(20, 10);
            };

            const removeSubtask = (taskId, subtaskId) => {
                setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: (t.subtasks || []).filter(st => st.id !== subtaskId) } : t));
            };

            // Modal Actions
            const confirmRename = () => {
                if (tempInput.trim()) {
                    setPlayer(p => ({ ...p, base: { ...p.base, [modalConfig.type === 'rename_tree' ? 'treeName' : 'petName']: tempInput } }));
                }
                setModalConfig(null); setTempInput('');
                showToast("ÂëΩÂêçÊàêÂäüÔºÅ");
            };

            const confirmSpecies = (speciesKey) => {
                setPlayer(p => ({ ...p, base: { ...p.base, petType: speciesKey, petName: PET_SPECIES[speciesKey].name } }));
                setModalConfig(null);
                SoundEngine.play('success');
                confetti();
            };

            const confirmEvolution = (pathKey) => {
                setPlayer(p => ({ ...p, base: { ...p.base, divinePath: pathKey } }));
                setModalConfig(null);
                SoundEngine.play('success');
                confetti();
            };

            const initiateComplete = (task) => {
                setModalConfig({ type: 'complete_confirm', task });
            };

            const confirmComplete = (archive) => {
                const task = modalConfig.task;
                const expBonus = task.isBoss ? 500 : 0;
                const goldBonus = task.isBoss ? 1000 : 0;

                addExp(task.exp + expBonus);
                setPlayer(p => ({ ...p, gold: p.gold + task.gold + goldBonus }));
                
                if (archive) {
                    setHistory([{ ...task, completedAt: Date.now() }, ...history]);
                }
                setTasks(tasks.filter(t => t.id !== task.id));
                setModalConfig(null);
                
                if (task.isBoss) SoundEngine.play('victory');
                else SoundEngine.play('success');
                
                confetti();
                showToast(`üéâ ‰ªªÂãôÂÆåÊàêÔºÅÁç≤ÂæóÂ§ßÈáèÁçéÂãµ`);
            };

            const handleEncounter = () => {
                if (!activeEncounter) return;
                setModalConfig({ type: 'encounter', data: activeEncounter });
            };

            const confirmEncounter = () => {
                const enc = modalConfig.data;
                const reward = enc.reward || {};
                
                setPlayer(p => {
                    let newP = { ...p };
                    if (reward.gold) newP.gold += reward.gold;
                    if (reward.energy) newP.energy = Math.min(maxEnergy, newP.energy + reward.energy);
                    if (reward.items) Object.keys(reward.items).forEach(k => { newP.items[k] = (newP.items[k] || 0) + reward.items[k]; });
                    if (reward.potions) Object.keys(reward.potions).forEach(k => { newP.potions[k] = (newP.potions[k] || 0) + reward.potions[k]; });
                    return newP;
                });
                
                if (reward.exp) addExp(reward.exp);

                setActiveEncounter(null);
                setModalConfig(null);
                SoundEngine.play('success');
                showToast("Â•áÈÅáÁµêÊùüÔºåÊî∂Á©´ÊªøÊªøÔºÅ");
            };

            const handleReminderClick = (index) => {
                const reminder = pendingReminders[index];
                addExp(reminder.reward.exp);
                setPlayer(p => ({ ...p, energy: Math.min(maxEnergy, p.energy + reminder.reward.energy) }));
                
                const newReminders = [...pendingReminders];
                newReminders.splice(index, 1);
                setPendingReminders(newReminders);
                
                SoundEngine.play('success');
                confetti();
                showToast(`‚úÖ ÂÆåÊàêÊèêÈÜíÔºö${reminder.text.split(' ')[1] || 'ÂÅ•Â∫∑ÁîüÊ¥ª'} (ËÉΩÈáè +${reminder.reward.energy}, XP +${reminder.reward.exp})`);
            };

            const treeStage = GrowthSystem.getTreeStage(player.base.treeExp);
            const petStage = GrowthSystem.getPetStage(player.base.petExp, player.base.petType, player.base.divinePath);

            const treeTooltip = (
                <div className="text-left space-y-1">
                    <div className="font-bold border-b border-white/20 pb-1 mb-1">{treeStage.icon} {treeStage.name}</div>
                    <div>Áï∂ÂâçÁ∂ìÈ©ó: {player.base.treeExp}</div>
                    {treeStage.nextExp ? <div className="text-green-400">‰∏ã‰∏ÄÈöé: {treeStage.next} (ÈúÄ {treeStage.nextExp})</div> : <div className="text-yellow-400">Â∑≤ÈÅîÊúÄÈ´òÈöéÊÆµ</div>}
                </div>
            );

            const petTooltip = (
                <div className="text-left space-y-1">
                    <div className="font-bold border-b border-white/20 pb-1 mb-1">{petStage.icon} {petStage.name}</div>
                    <div>Áï∂ÂâçÁ∂ìÈ©ó: {player.base.petExp}</div>
                    {petStage.nextExp ? <div className="text-orange-400">‰∏ã‰∏ÄÈöé: {petStage.next} (ÈúÄ {petStage.nextExp})</div> : <div className="text-yellow-400">Â∑≤ÈÅîÊúÄÈ´òÈöéÊÆµ</div>}
                </div>
            );

            const goldTooltip = (<div className="text-left"><div className="font-bold text-yellow-400">ÂÜíÈö™ËÄÖÈáëÂπ£</div><div className="text-white/70">ÂÆåÊàê‰ªªÂãôÂèØÁç≤ÂæóÔºåÁî®ÊñºÂú®‰∫§ÊòìÊâÄË≥ºË≤∑Áâ©Ë≥á„ÄÇ</div></div>);
            const xpTooltip = (<div className="text-left"><div className="font-bold text-primary">ÂÜíÈö™Á∂ìÈ©óÂÄº</div><div className="text-white/70">Á¥ØÁ©çÁ∂ìÈ©óÊèêÂçáÁ≠âÁ¥ö (Lv.9 Ëß£ÈéñÁßòÂØÜÂü∫Âú∞)„ÄÇ</div></div>);
            const energyTooltip = (<div className="text-left"><div className="font-bold text-orange-400">ÁîüÂ≠òËÉΩÈáè</div><div className="text-white/70">Âü∑Ë°å‰ªªÂãôËàá‰∫íÂãïÈúÄË¶ÅËÉΩÈáè„ÄÇËá™ÁÑ∂ÊÅ¢Âæ©ÊàñÂêÉËó•Ê∞¥Ë£úÂÖÖ„ÄÇ</div></div>);
            
            const potionTooltips = {
                red: <div className="text-left"><div className="font-bold text-red-400">ÁîüÂëΩËó•Âäë</div><div className="text-white/70">Á´ãÂç≥ÊÅ¢Âæ© 60 ÈªûÁîüÂ≠òËÉΩÈáè„ÄÇ</div></div>,
                gold: <div className="text-left"><div className="font-bold text-yellow-400">ÈªûÈáëËó•Âäë</div><div className="text-white/70">Ê∂àËÄó 30 ËÉΩÈáèÔºåËΩâÂåñÁÇ∫ 1200 ÈáëÂπ£„ÄÇ</div></div>,
                purple: <div className="text-left"><div className="font-bold text-purple-400">Ë≥¢ËÄÖËó•Âäë</div><div className="text-white/70">Áõ¥Êé•Áç≤Âæó 2500 Á∂ìÈ©óÂÄº„ÄÇ</div></div>
            };

            return (
                <div className={`p-4 min-h-screen ${isShaking ? 'shake' : ''}`}>
                    {toast && (
                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 border-2 border-primary text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up z-50 pointer-events-none">
                            <span className="text-xl">‚ú®</span>
                            <span className="font-bold text-sm">{toast}</span>
                        </div>
                    )}

                    {modalConfig && (
                        <Modal 
                            title={
                                modalConfig.type === 'rename_tree' ? 'ÁÇ∫Á•ûÊú®ÂëΩÂêç' : 
                                modalConfig.type === 'rename_pet' ? 'ÁÇ∫Â§•‰º¥ÂëΩÂêç' : 
                                modalConfig.type === 'select_species' ? 'ÈÅ∏Êìá‰Ω†ÁöÑÂÆàË≠∑ÈùàÁç∏' : 
                                modalConfig.type === 'evolve_species' ? 'Á•ûÁç∏ÈÄ≤ÂåñÊäâÊìá' : 
                                modalConfig.type === 'complete_confirm' ? '‰ªªÂãôÂÆåÊàêÔºÅ' : 
                                modalConfig.type === 'encounter' ? '‚ú® Á™ÅÁôºÂ•áÈÅáÔºÅ' : 
                                modalConfig.type === 'adventure' ? 'ÈÅ∏ÊìáÊé¢Èö™Âú∞Èªû' : 
                                modalConfig.type === 'adventure_result' ? 'Êé¢Èö™Â†±Âëä' :
                                modalConfig.type === 'collection' ? 'ÂÜíÈö™ÂúñÈëë' : ''
                            } 
                            onClose={() => { if(modalConfig.type !== 'select_species' && modalConfig.type !== 'evolve_species') setModalConfig(null); }}
                            width={modalConfig.type==='collection'?'max-w-2xl':'max-w-sm'}
                        >
                            
                            {modalConfig.type.includes('rename') && (
                                <div className="space-y-4">
                                    <input autoFocus value={tempInput} onChange={e => setTempInput(e.target.value)} className="w-full bg-black/50 p-3 rounded-xl text-center text-lg outline-none border border-primary" placeholder="Ëº∏ÂÖ•ÂêçÂ≠ó..." />
                                    <button onClick={confirmRename} className="w-full bg-primary py-3 rounded-xl font-bold">Á¢∫Ë™ç</button>
                                </div>
                            )}

                            {modalConfig.type === 'adventure' && (
                                <div className="space-y-3">
                                    <div className="text-center mb-4">
                                        <div className="text-4xl mb-2">{petStage.icon}</div>
                                        <div className="text-sm opacity-70">È´îÂäõ: {player.base.petStamina}/100</div>
                                    </div>
                                    {ADVENTURE_LOCATIONS.map(loc => (
                                        <button key={loc.id} onClick={() => startAdventure(loc.id)} disabled={player.base.petStamina < loc.cost} className="w-full flex justify-between items-center bg-white/5 hover:bg-primary/20 p-3 rounded-xl border border-white/10 disabled:opacity-30 transition-all">
                                            <div className="text-left">
                                                <div className="font-bold">{loc.name}</div>
                                                <div className="text-xs opacity-50">ÈúÄ {loc.time} ÂàÜÈêò</div>
                                            </div>
                                            <div className="text-orange-400 font-bold">-{loc.cost} ‚ö°</div>
                                        </button>
                                    ))}
                                </div>
                            )}

                            {modalConfig.type === 'adventure_result' && (
                                <div className="text-center space-y-4">
                                    <div className="text-6xl animate-bounce">
                                        {modalConfig.result.type === 'success' ? 'üéâ' : modalConfig.result.type === 'injured' ? 'ü§ï' : 'üöë'}
                                    </div>
                                    <h3 className="text-xl font-bold">{modalConfig.result.msg}</h3>
                                    {/* Display Loot Card */}
                                    {modalConfig.result.loot && (
                                        <div className="bg-yellow-500/10 p-4 rounded-xl border border-yellow-500/50 animate-pop flex flex-col items-center gap-2">
                                            <div className="text-4xl">{COLLECTION_DB[modalConfig.result.loot].icon}</div>
                                            <div className="font-bold text-yellow-300">{COLLECTION_DB[modalConfig.result.loot].name}</div>
                                            <div className="text-xs opacity-70">{COLLECTION_DB[modalConfig.result.loot].desc}</div>
                                        </div>
                                    )}
                                    <button onClick={() => setModalConfig(null)} className="w-full bg-primary py-3 rounded-xl font-bold">Áü•ÈÅì‰∫Ü</button>
                                </div>
                            )}

                            {modalConfig.type === 'collection' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto">
                                    <div>
                                        <h4 className="font-bold text-center mb-2 border-b border-white/10 pb-2">Êòé‰ø°Áâá ({player.collection.postcards.length})</h4>
                                        <div className="grid grid-cols-2 gap-2">
                                            {player.collection.postcards.map(id => (
                                                <div key={id} className="bg-white/10 p-2 rounded-lg text-center">
                                                    <div className="text-2xl mb-1">{COLLECTION_DB[id].icon}</div>
                                                    <div className="text-xs font-bold">{COLLECTION_DB[id].name}</div>
                                                </div>
                                            ))}
                                            {player.collection.postcards.length===0 && <div className="text-xs opacity-30 col-span-2 text-center py-4">Â∞öÁÑ°Êî∂Ëóè</div>}
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-center mb-2 border-b border-white/10 pb-2">Â•áÁâ© ({player.collection.artifacts.length})</h4>
                                        <div className="grid grid-cols-2 gap-2">
                                            {player.collection.artifacts.map(id => (
                                                <div key={id} className="bg-yellow-500/10 p-2 rounded-lg text-center border border-yellow-500/20">
                                                    <div className="text-2xl mb-1">{COLLECTION_DB[id].icon}</div>
                                                    <div className="text-xs font-bold text-yellow-200">{COLLECTION_DB[id].name}</div>
                                                </div>
                                            ))}
                                            {player.collection.artifacts.length===0 && <div className="text-xs opacity-30 col-span-2 text-center py-4">Â∞öÁÑ°Êî∂Ëóè</div>}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {modalConfig.type === 'select_species' && (
                                <div className="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto">
                                    {Object.entries(PET_SPECIES).map(([key, data]) => (
                                        <button key={key} onClick={() => confirmSpecies(key)} className="bg-white/5 hover:bg-primary/20 p-4 rounded-xl flex flex-col items-center gap-2 border border-white/10 transition-all">
                                            <span className="text-4xl">{data.icon}</span>
                                            <span className="font-bold">{data.name}</span>
                                            <span className="text-[10px] opacity-60 text-center">{data.desc}</span>
                                        </button>
                                    ))}
                                </div>
                            )}

                            {modalConfig.type === 'evolve_species' && player.base.petType && (
                                <div className="space-y-4 text-center">
                                    <p className="text-sm opacity-80 mb-4">‰Ω†ÁöÑ {PET_SPECIES[player.base.petType].name} ÂäõÈáèÂ∑≤ÈÅîÂ∑îÂ≥∞ÔºåË´ãÈÅ∏ÊìáÈÄ≤ÂåñÂûãÊÖãÔºö</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        {Object.entries(PET_SPECIES[player.base.petType].evolutions).map(([key, data]) => (
                                            <button key={key} onClick={() => confirmEvolution(key)} className="bg-gradient-to-b from-slate-700 to-slate-900 hover:border-yellow-400 border-2 border-transparent p-4 rounded-xl flex flex-col items-center gap-2 transition-all">
                                                <span className="text-5xl animate-bounce">{data.icon}</span>
                                                <span className="font-bold text-yellow-400">{data.name}</span>
                                                <span className="text-[10px] opacity-60">{data.desc}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {modalConfig.type === 'encounter' && (
                                <div className="space-y-4 text-center">
                                    <div className="text-6xl animate-bounce mb-2">{modalConfig.data.icon}</div>
                                    <h4 className="text-xl font-bold">{modalConfig.data.title}</h4>
                                    <p className="text-white/70 text-sm">{modalConfig.data.desc}</p>
                                    <div className="bg-white/5 p-3 rounded-lg text-sm mt-2">
                                        {modalConfig.data.reward.gold && <span className="block text-yellow-400">üí∞ ÈáëÂπ£ {modalConfig.data.reward.gold > 0 ? '+' : ''}{modalConfig.data.reward.gold}</span>}
                                        {modalConfig.data.reward.exp && <span className="block text-primary">‚ú® Á∂ìÈ©ó {modalConfig.data.reward.exp > 0 ? '+' : ''}{modalConfig.data.reward.exp}</span>}
                                        {modalConfig.data.reward.energy && <span className="block text-orange-400">‚ö° ËÉΩÈáè {modalConfig.data.reward.energy > 0 ? '+' : ''}{modalConfig.data.reward.energy}</span>}
                                        {modalConfig.data.reward.items && Object.keys(modalConfig.data.reward.items).map(k => <span key={k} className="block text-green-400">üéí ÈÅìÂÖ∑ +{modalConfig.data.reward.items[k]}</span>)}
                                        {modalConfig.data.reward.potions && Object.keys(modalConfig.data.reward.potions).map(k => <span key={k} className="block text-purple-400">üß™ Ëó•Ê∞¥ +{modalConfig.data.reward.potions[k]}</span>)}
                                    </div>
                                    <button onClick={confirmEncounter} className="w-full bg-primary py-3 rounded-xl font-bold mt-2">
                                        {modalConfig.data.text}
                                    </button>
                                </div>
                            )}

                            {modalConfig.type === 'complete_confirm' && (
                                <div className="space-y-4 text-center">
                                    <p className="opacity-80">ÊÅ≠ÂñúÂÆåÊàê <span className="font-bold text-primary">{modalConfig.task.content}</span>ÔºÅ</p>
                                    <p className="text-xs opacity-50">Áç≤Âæó {modalConfig.task.gold} Gold, {modalConfig.task.exp} XP {modalConfig.task.isBoss && <span className="text-red-400 block mt-1 font-bold">(Âê´BOSSÊìäÊÆ∫Âä†Êàê!)</span>}</p>
                                    <p className="text-sm my-4 font-bold">ÊòØÂê¶Ë¶ÅÂ∞áÊ≠§ÂÜíÈö™‰∫ãËπüÁïôÂ≠òÊñºÊ≠∑Âè≤Ôºü</p>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => confirmComplete(true)} className="bg-primary hover:brightness-110 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                            <Icon name="Archive" size={16} /> ÁïôÂ≠òÁ¥ÄÈåÑ
                                        </button>
                                        <button onClick={() => confirmComplete(false)} className="bg-red-500/20 hover:bg-red-500 hover:text-white text-red-400 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                            <Icon name="Trash2" size={16} /> Áõ¥Êé•Èä∑ÊØÄ
                                        </button>
                                    </div>
                                </div>
                            )}
                        </Modal>
                    )}

                    <header className="card max-w-5xl mx-auto p-6 rounded-3xl shadow-2xl border-b-4 border-primary flex flex-wrap gap-8 items-center relative overflow-visible">
                        <div className="flex flex-col gap-4 items-center">
                            <button onClick={() => setShowAvatars(!showAvatars)} className="text-5xl bg-white/5 p-4 rounded-2xl hover:bg-primary/20 transition-all">{player.avatar}</button>
                            <div className="flex gap-1">
                                {THEMES.map(t => <button key={t.id} onClick={()=>setPlayer({...player, theme: t.id})} className="w-4 h-4 rounded-full border border-white/10" style={{background: t.color}} />)}
                            </div>
                            {showAvatars && (
                                <div className="absolute top-24 left-6 z-50 bg-slate-800 p-3 rounded-xl grid grid-cols-4 gap-2 shadow-2xl border border-white/10 w-44">
                                    {AVATARS.map(a => <button key={a} onClick={()=>{setPlayer({...player, avatar: a}); setShowAvatars(false);}} className="text-2xl hover:scale-110 transition-transform">{a}</button>)}
                                </div>
                            )}
                        </div>

                        <div className="flex-1 space-y-4">
                            <div className="flex items-center justify-between gap-4">
                                <div className="flex items-center gap-4">
                                    <input value={player.name} onChange={e => setPlayer({...player, name: e.target.value})} className="bg-transparent font-black text-2xl outline-none border-b border-white/5 focus:border-primary w-40" />
                                    <Tooltip content={goldTooltip} position="bottom">
                                        <span className="text-yellow-500 font-bold cursor-help">üí∞ {player.gold}</span>
                                    </Tooltip>
                                </div>
                                <div className="flex items-center gap-3">
                                    {activeEncounter && (
                                        <button onClick={handleEncounter} className="relative animate-bounce bg-red-500/20 p-2 rounded-full border border-red-500 text-red-400 hover:bg-red-500 hover:text-white transition-colors">
                                            <Icon name="AlertCircle" size={20} />
                                        </button>
                                    )}
                                    {/* Fixed Reminder Dropdown */}
                                    <div className="relative" ref={reminderRef}>
                                        <button 
                                            onClick={() => setShowReminderDropdown(!showReminderDropdown)}
                                            className={`p-2 rounded-full border transition-colors ${pendingReminders.length > 0 ? 'bg-blue-500/20 border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-white' : 'border-white/10 text-white/30'}`}
                                        >
                                            <Icon name="Bell" size={20} />
                                            {pendingReminders.length > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full text-[10px] flex items-center justify-center text-white">{pendingReminders.length}</span>}
                                        </button>
                                        {showReminderDropdown && pendingReminders.length > 0 && (
                                            <div className="absolute top-full right-0 mt-2 w-64 bg-slate-800 border border-blue-500/30 rounded-xl shadow-2xl p-2 z-50 animate-pop">
                                                {pendingReminders.map((r, idx) => (
                                                    <div key={idx} onClick={() => handleReminderClick(idx)} className="p-3 hover:bg-white/10 rounded-lg cursor-pointer flex items-center gap-2 border-b border-white/5 last:border-0">
                                                        <span className="text-lg">üîî</span>
                                                        <div className="text-xs text-left">
                                                            <div className="font-bold text-blue-200">{r.text}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="font-mono text-sm opacity-50 border border-white/10 px-3 py-1 rounded-full bg-black/20">üïí {curTime.toLocaleTimeString()}</div>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <Tooltip content={xpTooltip} position="bottom">
                                    <div className="cursor-help">
                                        <div className="flex justify-between text-[10px] font-bold opacity-40 uppercase tracking-widest"><span>Lv.{player.lv} XP</span><span>{Math.floor(player.xp)} / {maxExp}</span></div>
                                        <div className="h-1.5 bg-white/5 rounded-full overflow-hidden"><div className="h-full bg-primary transition-all duration-700" style={{width:`${(player.xp/maxExp)*100}%`}} /></div>
                                    </div>
                                </Tooltip>
                                <Tooltip content={energyTooltip} position="bottom">
                                    <div className="cursor-help">
                                        <div className="flex justify-between text-[10px] font-bold opacity-40 uppercase tracking-widest text-orange-400"><span>Energy</span><span>{Math.floor(player.energy)} / {maxEnergy}</span></div>
                                        <div className="h-1.5 bg-white/5 rounded-full overflow-hidden"><div className="h-full bg-orange-500 transition-all duration-700" style={{width:`${(player.energy/maxEnergy)*100}%`}} /></div>
                                    </div>
                                </Tooltip>
                            </div>
                        </div>

                        <div className="flex flex-col gap-2 min-w-[140px]">
                            {['red', 'gold', 'purple'].map(type => (
                                <Tooltip key={type} content={potionTooltips[type]} position="bottom">
                                    <button onClick={() => usePotion(type)} className={`w-full flex justify-between p-2 rounded-lg text-[10px] font-bold border hover:brightness-125 ${type==='red'?'bg-red-500/10 border-red-500/20 text-red-400':type==='gold'?'bg-yellow-500/10 border-yellow-500/20 text-yellow-400':'bg-purple-500/10 border-purple-500/20 text-purple-400'}`}>
                                        <span>{type==='red'?'üß™ ÁîüÂëΩËó•Âäë':type==='gold'?'üß™ ÈªûÈáëËó•Âäë':'üß™ Ë≥¢ËÄÖËó•Âäë'}</span><span>{player.potions[type]}</span>
                                    </button>
                                </Tooltip>
                            ))}
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <aside className="space-y-6 flex flex-col">
                            {/* 1. ÂßîË®óÊó•Ë™å */}
                            <div className="card p-6 rounded-2xl border-t-2 border-primary order-1">
                                <h3 className="font-bold text-primary mb-4 text-xs uppercase tracking-widest flex justify-between items-center">
                                    <span>üìú ÂßîË®óÊó•Ë™å</span>
                                    <button onClick={() => setViewMode(viewMode === 'active' ? 'history' : 'active')} className={`text-[10px] px-2 py-1 rounded border transition-colors ${viewMode === 'history' ? 'bg-primary text-white border-transparent' : 'border-white/20 hover:border-white/50 text-white/50 hover:text-white'}`}>
                                        {viewMode === 'active' ? 'ÂàáÊèõÊ≠∑Âè≤' : 'ËøîÂõû‰ªªÂãô'}
                                    </button>
                                </h3>
                                
                                {viewMode === 'active' ? (
                                    <>
                                        <input value={input.text} onChange={e => setInput({...input, text: e.target.value})} className="w-full bg-black/30 p-4 rounded-xl mb-4 border border-white/5 outline-none focus:border-primary/50" placeholder="ÂØ´‰∏ã‰Ω†ÁöÑÁõÆÊ®ô..." />
                                        <div className="flex gap-2 mb-4 bg-black/20 p-1 rounded-lg">
                                            <button onClick={() => setInput({ ...input, mode: 'duration' })} className={`flex-1 py-1 rounded text-xs font-bold transition-all ${input.mode === 'duration' ? 'bg-primary text-white' : 'text-white/30'}`}>Âø´ÈÄüÊôÇÊï∏</button>
                                            <button onClick={() => setInput({ ...input, mode: 'date' })} className={`flex-1 py-1 rounded text-xs font-bold transition-all ${input.mode === 'date' ? 'bg-primary text-white' : 'text-white/30'}`}>ÊåáÂÆöÊó•Êúü</button>
                                        </div>
                                        {input.mode === 'duration' ? (
                                            <div className="grid grid-cols-4 gap-2 mb-4">
                                                {[1,2,4,6,12,24,72,168].map(h => <button key={h} onClick={()=>setInput({...input, hours:h})} className={`p-2 rounded text-[10px] border transition-all ${input.hours===h?'bg-primary border-primary':'border-white/5 opacity-30'}`}>{h}h</button>)}
                                            </div>
                                        ) : (
                                            <div className="mb-4">
                                                <div className="relative">
                                                    <input type="datetime-local" className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-sm text-white outline-none focus:border-primary" onChange={(e) => setInput({ ...input, date: e.target.value })} />
                                                    <div className="absolute right-3 top-3 pointer-events-none opacity-50"><Icon name="Calendar" /></div>
                                                </div>
                                            </div>
                                        )}
                                        <button onClick={handleAddTask} className="w-full bg-primary py-4 rounded-xl font-black shadow-lg hover:brightness-110 active:scale-95 transition-all">ÁôºÂ∏ÉÂ•ëÁ¥Ñ</button>
                                    </>
                                ) : (
                                    <div className="text-center py-4 opacity-50 text-xs border border-dashed border-white/10 rounded-xl">
                                        Âè≥ÂÅ¥È°ØÁ§∫Ê≠∑Âè≤Â∞ÅÂ≠òÊ™îÊ°à
                                    </div>
                                )}
                            </div>

                            {/* 2. ÁßòÂØÜÂü∫Âú∞ */}
                            <div className="card p-6 rounded-2xl border-l-4 border-green-600/50 order-2 relative overflow-hidden">
                                {player.lv < 9 && (
                                    <div className="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center text-center p-4 backdrop-blur-sm">
                                        <Icon name="Lock" size={48} className="text-white/20 mb-2" />
                                        <h3 className="font-bold text-white text-lg">ÁßòÂØÜÂü∫Âú∞Êú™Ëß£Èéñ</h3>
                                        <p className="text-white/50 text-xs mt-1">ÈúÄÈÅîÂà∞Á≠âÁ¥ö 9 ÊâçËÉΩÈñãÂïü</p>
                                    </div>
                                )}
                                <h3 className="font-bold text-green-500 mb-6 text-xs uppercase tracking-widest flex justify-between items-center">
                                    <span>üè° ÁßòÂØÜÂü∫Âú∞</span>
                                    <div className="flex gap-2">
                                        <button onClick={() => setModalConfig({type: 'collection'})} className="text-[10px] border border-white/20 px-2 py-1 rounded hover:bg-white/10">üìñ ÂúñÈëë</button>
                                        <BulkInput value={bulkAmount} onChange={setBulkAmount} />
                                    </div>
                                </h3>
                                <div className="space-y-6">
                                    <div className="bg-black/20 p-4 rounded-2xl border border-white/5 relative">
                                        <div className="absolute top-2 right-2"><button onClick={()=>{setTempInput(player.base.treeName); setModalConfig({type:'rename_tree'})}} className="text-white/30 hover:text-white p-1"><Icon name="Edit3" size={12} /></button></div>
                                        <div className="flex items-center gap-4 mb-4">
                                            <Tooltip content={treeTooltip} position="top">
                                                <div className={`text-5xl transition-transform cursor-help ${activeAnim==='f'?'animate-pop':''}`}>{treeStage.icon}</div>
                                            </Tooltip>
                                            <div className="flex-1">
                                                <div className="text-sm font-bold mb-1 flex items-center gap-2">{player.base.treeName} <span className="text-[10px] bg-green-900/50 px-1.5 rounded text-green-400">{treeStage.name}</span></div>
                                                <div className="text-[10px] opacity-50 mb-1">ÊûúÂØ¶ÈÄ≤Â∫¶ {Math.floor(player.base.treeProgress)}%</div>
                                                <div className="h-1.5 bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-green-500 transition-all duration-1000" style={{width: `${player.base.treeProgress}%`}}></div></div>
                                            </div>
                                        </div>
                                        {player.base.treeProgress >= 100 ? (
                                             <button onClick={harvestFruit} className="w-full bg-yellow-500 hover:bg-yellow-400 text-black py-3 rounded-xl font-black shadow-lg text-lg animate-bounce">üçé Êé°Êî∂Â•áËπüÊûúÂØ¶</button>
                                        ) : (
                                            <button onClick={()=>handleBaseAction('fertilize')} disabled={player.items.fertilizer<=0} className="w-full bg-green-600 hover:bg-green-500 disabled:bg-gray-700 disabled:opacity-50 text-white py-3 rounded-xl font-black shadow-lg flex items-center justify-center gap-2 transition-all cursor-pointer active:scale-95 active:bg-white/20">
                                                <span>üíß</span> ÊñΩËÇ• {((Number(bulkAmount)||1) > 1) ? `(x${Math.min((Number(bulkAmount)||1), player.items.fertilizer)})` : `(${player.items.fertilizer})`}
                                            </button>
                                        )}
                                    </div>
                                    <div className="bg-black/20 p-4 rounded-2xl border border-white/5 relative">
                                        <div className="absolute top-2 right-2 flex gap-2">
                                            <button onClick={()=>{setTempInput(player.base.petName); setModalConfig({type:'rename_pet'})}} className="text-white/30 hover:text-white p-1"><Icon name="Edit3" size={12} /></button>
                                        </div>
                                        <div className="flex items-center gap-4 mb-4">
                                            <Tooltip content={petTooltip} position="top">
                                                <div className={`text-5xl transition-transform cursor-help ${activeAnim==='p'||activeAnim==='toy'?'animate-pop':''}`}>{petStage.icon}</div>
                                            </Tooltip>
                                            <div className="flex-1">
                                                <div className="text-sm font-bold mb-1 flex items-center gap-2">
                                                    {player.base.petName} <span className="text-[10px] bg-orange-900/50 px-1.5 rounded text-orange-400">{petStage.name}</span>
                                                    {player.base.petMood < 30 && <span className="text-[10px] text-red-400 animate-pulse">(ÊÉ≥‰∏ª‰∫∫...)</span>}
                                                </div>
                                                <div className="flex gap-1 text-[10px] opacity-70 mb-1">
                                                    <span className={player.base.petHunger<30?'text-red-400':''}>È£ΩÈ£ü {player.base.petHunger}</span> | <span className={player.base.petMood<30?'text-blue-400':''}>ÂøÉÊÉÖ {player.base.petMood}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {/* Pet Action Area - Updated to handle exploring state */}
                                        {player.base.petStatus === 'exploring' ? (
                                            <div className="text-center py-3 bg-white/5 rounded-xl text-xs flex flex-col gap-1">
                                                <span className="animate-pulse">Ê≠£Âú®Êé¢Èö™‰∏≠...</span>
                                                {player.base.adventureEndTime && (
                                                     <span className="font-mono text-orange-400">
                                                        Ââ©È§ò {formatTime(player.base.adventureEndTime - curTime.getTime())}
                                                     </span>
                                                )}
                                            </div>
                                        ) : player.base.petStatus === 'critical' ? (
                                            <div className="grid grid-cols-2 gap-2">
                                                <button onClick={()=>treatPet('med_kit')} disabled={player.items.med_kit<=0} className="col-span-2 bg-red-700 hover:bg-red-600 disabled:opacity-50 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><span>üöë</span> ÊÄ•Êïë (ÈáçÂÇ∑)</button>
                                            </div>
                                        ) : player.base.petStatus === 'injured' ? (
                                            <div className="grid grid-cols-2 gap-2">
                                                 <button onClick={()=>treatPet('bandage')} disabled={player.items.bandage<=0} className="col-span-2 bg-red-500/50 hover:bg-red-500 border border-red-500 disabled:opacity-50 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><span>ü©π</span> ÂåÖÁ¥Æ (ËºïÂÇ∑)</button>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={()=>handleBaseAction('feed')} disabled={player.items.food<=0} className="bg-orange-600 hover:bg-orange-500 disabled:bg-gray-700 disabled:opacity-50 text-white py-3 rounded-xl font-black shadow-lg flex items-center justify-center gap-2 transition-all cursor-pointer active:scale-95 active:bg-white/20">
                                                        <span>ü•©</span> È§µÈ£ü {((Number(bulkAmount)||1) > 1) ? `(x${Math.min((Number(bulkAmount)||1), player.items.food)})` : `(${player.items.food})`}
                                                    </button>
                                                    <button onClick={()=>setModalConfig({type:'adventure'})} className="bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:opacity-50 text-white py-3 rounded-xl font-black shadow-lg flex items-center justify-center gap-2 transition-all cursor-pointer active:scale-95 active:bg-white/20">
                                                        <span>üéí</span> Êé¢Èö™
                                                    </button>
                                                </div>
                                                <button onClick={()=>handleBaseAction('toy')} disabled={player.items.toy<=0} className="w-full bg-pink-600 hover:bg-pink-500 disabled:bg-gray-700 disabled:opacity-50 text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2 text-xs transition-all cursor-pointer active:scale-95 active:bg-white/20">
                                                    <span>üß∂</span> Áé©ËÄç {((Number(bulkAmount)||1) > 1) ? `(x${Math.min((Number(bulkAmount)||1), player.items.toy)})` : `(${player.items.toy})`}
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* 3. ‰∫§ÊòìÊâÄ */}
                            <div className="card p-6 rounded-2xl border-l-4 border-yellow-600/50 order-3">
                                <h3 className="font-bold text-yellow-500 mb-4 text-xs uppercase tracking-widest flex justify-between items-center">
                                    <span>üõí ‰∫§ÊòìÊâÄ</span>
                                    <BulkInput value={bulkAmount} onChange={setBulkAmount} />
                                </h3>
                                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scroll">
                                    {SHOP_ITEMS.map(item => (
                                        <button key={item.i} onClick={()=>shopBuy(item.i,item.t,item.c)} className="w-full flex justify-between bg-white/5 p-3 rounded-xl text-[11px] hover:bg-white/10 transition-all cursor-pointer active:scale-95 active:bg-white/20 group relative">
                                            <div className="text-left">
                                                <div>{item.n} (${item.c * (Number(bulkAmount)||1)})</div>
                                                <div className="text-[9px] opacity-40">{item.desc}</div>
                                            </div>
                                            <div className="flex items-center">
                                                <span>{item.t==='item'?player.items[item.i]:player.potions[item.i]}</span>
                                            </div>
                                        </button>
                                    ))}
                                    {player.items.fruit > 0 && <div className="text-[10px] text-center text-green-400 mt-2">ËÉåÂåÖ‰∏≠Êúâ {player.items.fruit} È°ÜÂ•áËπüÊûúÂØ¶</div>}
                                </div>
                            </div>
                        </aside>

                        <section className="lg:col-span-2 space-y-4">
                            {viewMode === 'active' ? (
                                <>
                                    {tasks.map(t => {
                                        const remainingHours = Math.max(0, Math.floor((t.deadline - curTime)/3600000));
                                        const isExpanded = expandedTaskId === t.id;
                                        const completedSubtasks = t.subtasks ? t.subtasks.filter(st => st.completed).length : 0;
                                        const totalSubtasks = t.subtasks ? t.subtasks.length : 0;
                                        
                                        const cardClass = t.isBoss ? "boss-card shadow-2xl scale-[1.02] border-2" : "card border-l-4 border-primary";
                                        const bossHp = totalSubtasks > 0 ? ((totalSubtasks - completedSubtasks) / totalSubtasks) * 100 : (completedSubtasks > 0 ? 0 : 100);
                                        const shakeClass = activeAnim === t.id ? 'damage-shake' : '';

                                        return (
                                            <div key={t.id} className={`${cardClass} rounded-2xl transition-all overflow-hidden mb-4 ${shakeClass}`}>
                                                <div className="p-6 flex justify-between items-center cursor-pointer hover:bg-white/5" onClick={() => setExpandedTaskId(isExpanded ? null : t.id)}>
                                                    <div className="flex-1 space-y-2">
                                                        <div className="flex items-center gap-3">
                                                            <span className={`text-2xl ${t.isBoss ? 'text-4xl boss-icon animate-bounce' : ''}`}>{t.icon || 'üìú'}</span>
                                                            <h4 className={`font-bold ${t.isBoss ? 'text-xl text-red-200' : 'text-lg'}`}>{t.content}</h4>
                                                            {totalSubtasks > 0 && <span className="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded-full">{completedSubtasks}/{totalSubtasks}</span>}
                                                        </div>
                                                        
                                                        {t.isBoss && (
                                                            <div className="w-full max-w-xs h-3 bg-black/50 rounded-full overflow-hidden border border-red-900/50">
                                                                <div className="h-full bg-red-600 transition-all duration-300" style={{width: `${bossHp}%`}}></div>
                                                            </div>
                                                        )}

                                                        <div className="flex flex-wrap gap-3 text-[10px] font-bold opacity-60 uppercase tracking-widest">
                                                            <span className="bg-white/10 px-2 py-0.5 rounded text-white">{t.type || 'Êó•Â∏∏'}</span>
                                                            <span className={remainingHours < 3 ? 'text-red-400 animate-pulse' : ''}>‚è≥ {remainingHours}HR</span>
                                                            <span className="text-yellow-500">Gold {t.gold}</span>
                                                            <span className="text-primary">XP {t.exp}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-4 items-center">
                                                        <button onClick={(e)=>{ e.stopPropagation(); setIsShaking(true); SoundEngine.play('fail'); setPlayer(p=>({...p, gold:Math.floor(p.gold*0.3), energy:Math.max(0,p.energy-60)})); setTasks(tasks.filter(tk=>tk.id!==t.id)); setTimeout(()=>setIsShaking(false),400); }} className="text-xs font-bold text-red-500/30 hover:text-red-500 transition-colors p-2">ÊîæÊ£Ñ</button>
                                                        {(!t.isBoss || totalSubtasks === 0 || completedSubtasks === totalSubtasks) && (
                                                            <button onClick={(e)=>{ e.stopPropagation(); initiateComplete(t); }} className="bg-primary text-white px-6 py-2 rounded-xl font-black shadow-lg hover:scale-105 transition-transform cursor-pointer active:scale-95">
                                                                {t.isBoss ? '‚öîÔ∏è Êñ¨ÊÆ∫' : 'ÂÆåÊàê'}
                                                            </button>
                                                        )}
                                                        <div className="opacity-50 hover:opacity-100 transition-opacity"><Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} /></div>
                                                    </div>
                                                </div>
                                                
                                                {isExpanded && (
                                                    <div className="bg-black/20 p-4 border-t border-white/5">
                                                        {t.isBoss && <div className="text-xs text-red-400 mb-2 font-bold text-center">ÊìäÁ†¥Âº±Èªû‰ª•ÂâäÊ∏õ BOSS ÁîüÂëΩÂÄºÔºÅ</div>}
                                                        <div className="space-y-2 mb-4">
                                                            {t.subtasks && t.subtasks.map(st => (
                                                                <div key={st.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 group">
                                                                    <button onClick={() => toggleSubtask(t.id, st.id)} className={`transition-colors ${st.completed ? 'text-primary' : 'text-white/20 hover:text-white/50'}`}>
                                                                        {t.isBoss ? (st.completed ? <span className="text-lg">üí•</span> : <Icon name="Sword" size={18} className="text-red-400" />) : <Icon name={st.completed ? "CheckSquare" : "Square"} />}
                                                                    </button>
                                                                    <span className={`flex-1 text-sm ${st.completed ? 'line-through opacity-30' : 'opacity-80'}`}>{st.text}</span>
                                                                    <button onClick={() => removeSubtask(t.id, st.id)} className="opacity-0 group-hover:opacity-100 text-red-400/50 hover:text-red-400 transition-all cursor-pointer"><Icon name="Trash2" size={14} /></button>
                                                                </div>
                                                            ))}
                                                            {(!t.subtasks || t.subtasks.length === 0) && <div className="text-center text-xs opacity-30 py-2">Â∞öÊú™Êñ∞Â¢û{t.isBoss ? 'Âº±Èªû' : 'Â≠ê‰ªªÂãô'}</div>}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <input type="text" placeholder={t.isBoss ? "Êñ∞Â¢ûÂº±Èªû (‰æãÂ¶Ç: ÊâæË≥áÊñô)..." : "Ëº∏ÂÖ•Â≠ê‰ªªÂãô..."} className="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary" onKeyDown={(e) => { if (e.key === 'Enter') { addSubtask(t.id, e.target.value); e.target.value = ''; } }} />
                                                            <button className="bg-white/10 hover:bg-primary hover:text-white px-3 rounded-lg transition-colors cursor-pointer active:scale-95" onClick={(e) => { const input = e.target.previousSibling; addSubtask(t.id, input.value); input.value = ''; }}><Icon name="Plus" size={16} /></button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {tasks.length === 0 && <div className="text-center py-20 opacity-20 font-bold text-xl">ÁõÆÂâç‰ΩàÂëäÊ¨ÑÁ©∫Á©∫Â¶Ç‰πü...</div>}
                                </>
                            ) : (
                                <div className="space-y-4">
                                    <div className="text-center pb-4 border-b border-white/10 mb-4">
                                        <h3 className="text-xl font-bold text-white/50">üìú Ê≠∑Âè≤Âç∑Ëª∏</h3>
                                        <p className="text-xs opacity-30">Á¥ÄÈåÑËëó‰Ω†ÈÅéÂéªÁöÑË±êÂäüÂÅâÊ•≠</p>
                                    </div>
                                    {history.map(t => (
                                        <div key={t.id} className="card p-4 rounded-xl flex items-center gap-4 border-l-4 border-slate-600 opacity-60 hover:opacity-100 transition-opacity">
                                            <span className="text-2xl grayscale">{t.icon}</span>
                                            <div className="flex-1">
                                                <h4 className="font-bold line-through decoration-white/30">{t.content}</h4>
                                                <p className="text-[10px] opacity-50">ÂÆåÊàêÊñº {new Date(t.completedAt).toLocaleString()}</p>
                                            </div>
                                            <span className="text-xs font-bold text-slate-400">Â∑≤Ê≠∏Ê™î</span>
                                        </div>
                                    ))}
                                    {history.length === 0 && <div className="text-center py-10 opacity-20">Â∞öÁÑ°Ê≠∑Âè≤Á¥ÄÈåÑ</div>}
                                </div>
                            )}
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>